# toyutoyu-suporter

と湯と湯という温泉ポータルサイトが疎通しているかを通知するLine Bot。

`https://toyutoyu.com/app/` と `https://toyutoyu.com/` を15分ごとに疎通確認し、失敗時に通知します。

## 動作

- Cron: 15分ごと（既定: `*/15 * * * *`、タイムゾーン既定: `Asia/Tokyo`）
- 監視: HTTP 2xx と 404 を成功扱い、その他は失敗扱い
- 通知: 常にログ出力。加えてLINE Push通知は環境変数が揃っている場合のみ実施

## 環境変数

- `TARGET_URLS`（任意）: カンマ区切りURL（未指定時は2URLを監視）
- `CRON_SCHEDULE`（任意）: 既定 `*/15 * * * *`
- `CRON_TIMEZONE`（任意）: 既定 `Asia/Tokyo`
- `TIMEOUT_MS`（任意）: 既定 `10000`

LINE（任意）

- `LINE_CHANNEL_ACCESS_TOKEN`: Messaging APIのチャネルアクセストークン（Pushに必要）
- `LINE_TO`: 送信先（userId / groupId / roomId）
- `LINE_BROADCAST`: `1` の場合は全員に配信（LINE側のBroadcast権限/制限に依存）
- `LINE_CHANNEL_SECRET`: Webhook署名検証用（Webhookを使う場合のみ）

認証/ポイント連携（任意。LINEで「ログイン」「ポイント」を使う場合）

- `TOYUTOYU_WP_BASE_URL`: 既定 `https://toyutoyu.com/app/`
- `LOGIN_FLOW_TTL_MS`: ログイン途中状態のTTL（既定 10分）
- `LOGGED_IN_TTL_MS`: ログイン済み状態のTTL（既定 60分）

AI自動応答（任意。ログイン/ポイント以外の問い合わせに自動返信する場合）

- `OPENAI_API_KEY`: OpenAI APIキー
- `OPENAI_MODEL`: 既定 `gpt-4o`

※ご提示の「Channel」/「Channel secret」のうち、通知（Push）に必須なのは `LINE_CHANNEL_ACCESS_TOKEN` です。

## ローカル実行

```bash
npm install
npm start
```

## Fly.io デプロイ

1. `fly.toml` の `app` 名をユニークな名前に変更

1. シークレットを設定（LINE通知する場合）

```bash
fly secrets set LINE_CHANNEL_ACCESS_TOKEN=...
```

※全員配信（Broadcast）では `LINE_TO` は不要です。特定宛先にPushする場合のみ `LINE_TO` を設定してください。

1. デプロイ

```bash
fly deploy
```

Webhookは任意です。必要なら `POST /callback` をLINE Developersで設定してください。

## LINEでの使い方

Webhook（`/callback`）にメッセージが届いた場合、以下の簡易フローで応答します。

- 「ログイン」→ メールアドレス → パスワード（`auth-check` による検証）
- ログイン後に「ポイント」→ `user-points` をメールアドレスで取得して返信

※ログイン状態はサーバーのメモリ上に保持します（プロセス再起動で消えます）。

---

## と湯と湯｜よくあるご質問（Q&A）♨️

Q1. 「と湯と湯」はどんなサービスですか？

A.
「と湯と湯」は、提携している温泉・サウナ施設で共通して使えるポイント制サービスです♨️
ポイントを使って入館料を支払えるため、回数券のようにお得に、さらに複数施設で利用できます。

---

Q2. どんな人におすすめですか？

A.
こんなお悩みはありませんか？👇

・もっとお得に温泉・サウナを利用したい
・施設ごとの回数券を管理するのが面倒
・今日はどこの施設に行くか迷ってしまう
・温泉やサウナに行くきっかけがほしい

「と湯と湯」なら、これらのお悩みをまとめて解決できます✨

---

Q3. 温泉やサウナもサブスクで使えますか？

A.
はい、使えます🙆‍♂️
映画や音楽のように、温泉・サウナもサブスク感覚で楽しめるサービスです。

思い立ったときに、気軽に、お得に利用できます。
※解約はいつでも可能で、解約後も残っているポイントはご利用いただけます。

---

Q4. 毎月の自動引き落としが不安です…

A.
その場合は、一括購入プランがおすすめです💡
自動引き落としはなく、好きなタイミングでポイントを購入できます。

---

Q5. 提携施設ならどこでも使えますか？

A.
はい、提携している温泉・サウナ施設であればどこでも利用可能です♨️

※一部施設では、岩盤浴やその他サービスにもポイントが使える場合があります。

---

Q6. 支払いはどうやって行いますか？

A.
アプリでポイントを購入し、入館時にポイントでお支払いするだけです📱
現金不要で、スムーズにご利用いただけます。

---

Q7. 年間でどれくらいお得になりますか？

A.
利用プランや利用頻度によっては、年間最大5万円ほどお得になる場合があります✨
ライフスタイルによっては、さらにお得になることもあります。

---

Q8. 家族や友達の分も支払えますか？

A.
はい、契約者ご本人が一緒であれば、同行者の分もポイントでまとめて支払い可能です👨‍👩‍👧‍👦
デートやご家族での利用にもおすすめです。

※お子様の料金は、施設によって現金のみ対応の場合があります。

---

Q9. ポイントは翌月に繰り越されますか？

A.
はい、繰り越されます🔁
使いきれなかったポイントは翌月以降も利用できます。

※現在、有効期限はありませんが、将来的に1年間の有効期限を設ける予定です。

---

Q10. 利用できる施設はどこですか？

A.
「と湯と湯」は、提携している温泉・サウナ施設のみでご利用いただけます。
アプリのマップ機能から、現在地や地域別に検索できます📍

👉 提携施設一覧を見る

---

Q11. どんなプランがありますか？

A.
以下の3種類のプランがあります👇

・サブスクプラン（毎月自動引き落とし）
・一括プラン（好きなタイミングで購入）
・追加購入（チャージ）プラン

👉 各プランの詳細はこちら

---

Q12. ポイントはどのように使いますか？

A.
ポイントは、各施設の入館料の支払いに使用できます。
必要なポイント数は施設ごとに異なります。

👉 ポイントの支払い方法はこちら

---

Q13. 間違った施設にポイントを使ってしまいました。返金できますか？

A.
基本的に、ポイントの返金・返還はできません。
ただし、状況によって対応できる場合もありますので、まずはお問い合わせください。

👉 お問い合わせはこちら

---

Q14. 解約はいつでもできますか？

A.
はい、いつでも可能です🙆‍♂️
違約金などは一切かかりません。

解約後も、残っているポイントは引き続き利用できます。
再入会もいつでも可能です。

👉 解約手続きはこちら

---

Q15. ポイント残高はどこで確認できますか？

A.
アプリまたは公式LINEのマイページから確認できます📊

---

Q16. ポイントの有効期限はありますか？

A.
現在、有効期限はありません。
ただし、今後設定する予定があり、その際は事前にお知らせいたします。

---

Q17. 利用はどこからできますか？

A.
以下の方法でご利用いただけます👇

👉 と湯と湯アプリ
👉 公式LINE
👉 ホームページ

---

### プランについてのQ&A 💰

Q18. サブスクプランの内容を教えてください

A.

サブスクプラン（毎月自動引き落とし）

・月額3,960円 → 450P付与（約540円分お得✨）
・7,920円 → 900P付与（約1,080円分お得✨）
・15,840円 → 1,800P付与（約2,160円分お得✨）
・31,680円 → 3,600P付与（約4,320円分お得✨）

---

Q19. 一括プランの内容を教えてください

A.

一括プラン（自動引き落としなし）

・3,960円 → 440P付与（約440円分お得✨）
・7,920円 → 900P付与（約900円分お得✨）
・15,840円 → 1,800P付与（約1,800円分お得✨）
・31,680円 → 3,600P付与（約3,600円分お得✨）

---

Q20. チャージプランとは何ですか？

A.
一括プランと同じお得率で、必要な分だけポイントを購入できるプランです➕
1ポイント単位で購入できます。

例：
「今日は520ポイントだけ欲しい」
→ 520ポイントだけ購入可能です🙆‍♂️

---

### 利用可能な提携施設 🏠♨️

【愛知県】

・福の湯

【岐阜県】

・一色の森プライベートサウナ
・SAUNA OHMA
・ヤオツサウナ
・やまと温泉 やすらぎ館


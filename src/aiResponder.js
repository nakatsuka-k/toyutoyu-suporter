function sanitizeUserText(text) {
  return String(text ?? "").trim().slice(0, 2000);
}

function buildSystemPrompt() {
  return [
    "ã‚ãªãŸã¯ã€Žã¨æ¹¯ã¨æ¹¯ã€ã®å…¬å¼LINE Botã§ã™ã€‚æ—¥æœ¬èªžã§ã€ä¸å¯§ã§ç°¡æ½”ã«è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚",
    "è¿”ä¿¡ã«ã¯çµµæ–‡å­—ã‚’1ã€œ3å€‹ç¨‹åº¦ã€è‡ªç„¶ã«æ·»ãˆã¦ãã ã•ã„ï¼ˆä¾‹: â™¨ï¸âœ¨ðŸ“±ðŸ™†â€â™‚ï¸ðŸ”ðŸ“ ãªã©ï¼‰ã€‚",
    "ä¸‹è¨˜ã®Q&Aã«æ²¿ã£ã¦å›žç­”ã—ã€Q&Aã«ãªã„ã“ã¨ã¯æ–­å®šã›ãšã€Žå…¬å¼ã‚µã‚¤ãƒˆ/ã‚¢ãƒ—ãƒªã§ç¢ºèªã€ã‚„ã€ŽãŠå•ã„åˆã‚ã›ã€ã¸æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚",
    "å€‹äººæƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã®å…¥åŠ›ã‚’ä¿ƒã™å ´åˆã¯ã€Žãƒ­ã‚°ã‚¤ãƒ³ã€ã®æ‰‹é †ã«èª˜å°Žã—ã€ãã‚Œä»¥å¤–ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’æ±‚ã‚ãªã„ã§ãã ã•ã„ã€‚",
    "\nã¨æ¹¯ã¨æ¹¯ï½œã‚ˆãã‚ã‚‹ã”è³ªå•ï¼ˆQ&Aï¼‰â™¨ï¸",
    "Q1. ã©ã‚“ãªã‚µãƒ¼ãƒ“ã‚¹ï¼Ÿ â†’ ææºæ¸©æ³‰/ã‚µã‚¦ãƒŠã§å…±é€šã—ã¦ä½¿ãˆã‚‹ãƒã‚¤ãƒ³ãƒˆåˆ¶ã€‚ãƒã‚¤ãƒ³ãƒˆã§å…¥é¤¨æ–™æ”¯æ‰•ã„ã€‚å›žæ•°åˆ¸ã®ã‚ˆã†ã«ãŠå¾—ãƒ»è¤‡æ•°æ–½è¨­ã§åˆ©ç”¨å¯ã€‚",
    "Q2. ãŠã™ã™ã‚ã¯ï¼Ÿ â†’ ãŠå¾—ã«åˆ©ç”¨/å›žæ•°åˆ¸ç®¡ç†ãŒé¢å€’/è¡Œãå…ˆã«è¿·ã†/ãã£ã‹ã‘ãŒã»ã—ã„ã€ã‚’ã¾ã¨ã‚ã¦è§£æ±ºã€‚",
    "Q3. ã‚µãƒ–ã‚¹ã‚¯ã§ä½¿ãˆã‚‹ï¼Ÿ â†’ ã¯ã„ã€‚æ°—è»½ã«ãŠå¾—ã«åˆ©ç”¨å¯ã€‚è§£ç´„ã¯ã„ã¤ã§ã‚‚å¯ã€‚è§£ç´„å¾Œã‚‚æ®‹ãƒã‚¤ãƒ³ãƒˆã¯åˆ©ç”¨å¯ã€‚",
    "Q4. è‡ªå‹•å¼•ãè½ã¨ã—ãŒä¸å®‰ â†’ ä¸€æ‹¬è³¼å…¥ãƒ—ãƒ©ãƒ³ï¼ˆè‡ªå‹•å¼•ãè½ã¨ã—ãªã—ï¼‰ã€‚å¥½ããªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è³¼å…¥ã€‚",
    "Q5. ææºæ–½è¨­ãªã‚‰ã©ã“ã§ã‚‚ï¼Ÿ â†’ ã¯ã„ã€‚æ–½è¨­ã«ã‚ˆã£ã¦ã¯å²©ç›¤æµ´ç­‰ã«ã‚‚ä½¿ãˆã‚‹å ´åˆã‚ã‚Šã€‚",
    "Q6. æ”¯æ‰•ã„æ–¹æ³• â†’ ã‚¢ãƒ—ãƒªã§ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ã€å…¥é¤¨æ™‚ã«ãƒã‚¤ãƒ³ãƒˆæ‰•ã„ã€‚ç¾é‡‘ä¸è¦ã§ã‚¹ãƒ ãƒ¼ã‚ºã€‚",
    "Q7. å¹´é–“ã©ã‚Œãã‚‰ã„ãŠå¾—ï¼Ÿ â†’ ãƒ—ãƒ©ãƒ³/é »åº¦ã«ã‚ˆã£ã¦ã¯å¹´é–“æœ€å¤§5ä¸‡å††ã»ã©ãŠå¾—ãªå ´åˆã‚ã‚Šã€‚",
    "Q8. å®¶æ—/å‹é”åˆ†ã‚‚æ‰•ãˆã‚‹ï¼Ÿ â†’ å¥‘ç´„è€…æœ¬äººãŒä¸€ç·’ãªã‚‰åŒè¡Œè€…åˆ†ã‚‚ã¾ã¨ã‚ã¦æ”¯æ‰•ã„å¯ã€‚å­ã©ã‚‚æ–™é‡‘ã¯æ–½è¨­ã«ã‚ˆã‚Šç¾é‡‘ã®ã¿ã®å ´åˆã‚ã‚Šã€‚",
    "Q9. ç¿Œæœˆç¹°ã‚Šè¶Šã— â†’ ã¯ã„ã€‚ç¾åœ¨ã¯æœ‰åŠ¹æœŸé™ãªã—ï¼ˆå°†æ¥çš„ã«1å¹´æœŸé™ã‚’è¨­ã‘ã‚‹äºˆå®šï¼‰ã€‚",
    "Q10. æ–½è¨­ã¯ã©ã“ï¼Ÿ â†’ ææºæ–½è¨­ã®ã¿ã€‚ã‚¢ãƒ—ãƒªã®ãƒžãƒƒãƒ—ã§ç¾åœ¨åœ°/åœ°åŸŸåˆ¥ã«æ¤œç´¢ã€‚",
    "Q11. ãƒ—ãƒ©ãƒ³ â†’ ã‚µãƒ–ã‚¹ã‚¯ï¼ˆæ¯Žæœˆè‡ªå‹•å¼•ãè½ã¨ã—ï¼‰/ä¸€æ‹¬ï¼ˆä»»æ„ã‚¿ã‚¤ãƒŸãƒ³ã‚°è³¼å…¥ï¼‰/è¿½åŠ è³¼å…¥ï¼ˆãƒãƒ£ãƒ¼ã‚¸ï¼‰ã€‚",
    "Q12. ãƒã‚¤ãƒ³ãƒˆã®ä½¿ã„æ–¹ â†’ å…¥é¤¨æ–™æ”¯æ‰•ã„ã«ä½¿ç”¨ã€‚å¿…è¦ãƒã‚¤ãƒ³ãƒˆã¯æ–½è¨­ã”ã¨ã«ç•°ãªã‚‹ã€‚",
    "Q13. é–“é•ã£ã¦ä½¿ã£ãŸ/è¿”é‡‘ â†’ åŽŸå‰‡ä¸å¯ã€‚çŠ¶æ³ã«ã‚ˆã‚Šå¯¾å¿œã§ãã‚‹å ´åˆã‚‚ã‚ã‚‹ãŸã‚å•ã„åˆã‚ã›ã€‚",
    "Q14. è§£ç´„ â†’ ã„ã¤ã§ã‚‚å¯ã€é•ç´„é‡‘ãªã—ã€‚è§£ç´„å¾Œã‚‚æ®‹ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨å¯ã€‚å†å…¥ä¼šã‚‚å¯ã€‚",
    "Q15. æ®‹é«˜ç¢ºèª â†’ ã‚¢ãƒ—ãƒªã¾ãŸã¯å…¬å¼LINEã®ãƒžã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèªã€‚",
    "Q16. æœ‰åŠ¹æœŸé™ â†’ ç¾åœ¨ãªã—ã€‚ä»Šå¾Œè¨­å®šã™ã‚‹å ´åˆã¯äº‹å‰å‘ŠçŸ¥ã€‚",
    "Q17. åˆ©ç”¨æ–¹æ³• â†’ ã‚¢ãƒ—ãƒª/å…¬å¼LINE/ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã€‚",
    "\nãƒ—ãƒ©ãƒ³ã«ã¤ã„ã¦ã®Q&A ðŸ’°",
    "Q18. ã‚µãƒ–ã‚¹ã‚¯ãƒ—ãƒ©ãƒ³: 3,960å††â†’450P / 7,920å††â†’900P / 15,840å††â†’1,800P / 31,680å††â†’3,600Pï¼ˆãã‚Œãžã‚ŒãŠå¾—åˆ†ã‚ã‚Šï¼‰ã€‚",
    "Q19. ä¸€æ‹¬ãƒ—ãƒ©ãƒ³: 3,960å††â†’440P / 7,920å††â†’900P / 15,840å††â†’1,800P / 31,680å††â†’3,600Pï¼ˆè‡ªå‹•å¼•ãè½ã¨ã—ãªã—ï¼‰ã€‚",
    "Q20. ãƒãƒ£ãƒ¼ã‚¸: ä¸€æ‹¬ã¨åŒç­‰ã®ãŠå¾—çŽ‡ã§å¿…è¦åˆ†ã ã‘è³¼å…¥ã€‚1ãƒã‚¤ãƒ³ãƒˆå˜ä½ã§è³¼å…¥å¯ã€‚",
    "\nåˆ©ç”¨å¯èƒ½ãªææºæ–½è¨­ï¼ˆå‚è€ƒï¼‰ðŸ â™¨ï¸",
    "æ„›çŸ¥çœŒ: ç¦ã®æ¹¯",
    "å²é˜œçœŒ: ä¸€è‰²ã®æ£®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µã‚¦ãƒŠã€SAUNA OHMAã€ãƒ¤ã‚ªãƒ„ã‚µã‚¦ãƒŠã€ã‚„ã¾ã¨æ¸©æ³‰ ã‚„ã™ã‚‰ãŽé¤¨",
    "\nãƒªãƒ³ã‚¯ï¼ˆæ¡ˆå†…ç”¨ï¼‰:",
    "å…¬å¼ã‚µã‚¤ãƒˆ: https://toyutoyu.com/",
    "æ–™é‡‘/ãƒ—ãƒ©ãƒ³: https://toyutoyu.com/price",
  ].join("\n");
}

async function generateAiReply({ apiKey, model, userText }) {
  const prompt = buildSystemPrompt();
  const content = sanitizeUserText(userText);

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "content-type": "application/json",
      "authorization": `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model,
      temperature: 0.3,
      max_tokens: 400,
      messages: [
        { role: "system", content: prompt },
        { role: "user", content },
      ],
    }),
  });

  if (!res.ok) {
    const body = await res.text().catch(() => "");
    const err = new Error(`OpenAI API failed: ${res.status} ${res.statusText} ${body}`.trim());
    err.status = res.status;
    throw err;
  }

  const data = await res.json();
  const text = data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
  return String(text ?? "").trim();
}

module.exports = {
  generateAiReply,
};
